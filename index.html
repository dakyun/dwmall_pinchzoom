<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Pinch Zoom – OliveYoung style (reset)</title>

<style>
  /* 리셋 */
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; }
  .spacer { height: 1000px; background:#f2f2f2; }

  /* ▼ 줌 영역 (페이지 세로 스크롤은 살리고, 핀치-줌 허용) */
  .pz {
    position: relative;
    overflow: hidden;
    touch-action: pan-y pinch-zoom;   /* 핵심: 세로 스와이프는 브라우저로 */
    background: #fff;
  }
  /* iScroll이 transform을 거는 곳 */
  .pz .scroller {
    transform-origin: 0 0;
    will-change: transform;
    backface-visibility: hidden;
  }
  .pz img {
    display:block;
    width:100%;
    height:auto;
    -webkit-user-drag:none;
    user-select:none;
    pointer-events:none;              /* 터치 포커스 끊김 방지 */
  }
</style>
</head>
<body>

<div class="spacer"></div>

<!-- ▼ 정확히 이 구조만 사용하세요 (자동 래핑/중첩 금지) -->
<div class="pz" id="pz1">
  <div class="scroller">
    <img src="https://dev-img.dongwonmall.com/dwmall/static_root/model_img/detail/184/86a4d8d7-8935-40fd-9cb4-a151ac52e504.jpg" alt="">
  </div>
</div>

<div class="spacer"></div>

<!-- iScrollZoom 먼저 로드 -->
<script src="js/libs/iscroll-zoom.js"></script>

<script>
/*
  올리브영식 구성:
  - eventPassthrough: 'vertical'  → 세로 제스처는 페이지 스크롤로 전달
  - scrollX: true, scrollY: false → 내부는 가로 패닝만
  - zoom: true                    → 핀치줌 iScroll이 처리
  - 하드 클램프: 점프/흰띠 방지
*/
(function(){
  var root = document.getElementById('pz1');
  var sc   = root.querySelector('.scroller');
  var img  = sc.querySelector('img');

  // 1) 1x 기준 높이를 정수로 고정(서브픽셀 오차 방지)
  function fixOneXHeight(){
    if (!(img.naturalWidth && img.naturalHeight)) return;
    var w = root.clientWidth || sc.clientWidth || img.clientWidth || img.naturalWidth;
    var h = Math.ceil(img.naturalHeight * (w / img.naturalWidth)); // 올림
    sc.style.height  = h + 'px';
    img.style.height = h + 'px';
  }

  // 이미지 준비 후 1x 높이 확정
  if (img.complete) fixOneXHeight();
  else img.addEventListener('load', fixOneXHeight, {once:true});

  // 2) iScrollZoom 인스턴스
  var z = new IScrollZoom(root, {
    zoom: true,
    zoomMin: 1,
    zoomMax: 4,
    startZoom: 1,

    scrollX: true,
    scrollY: false,                 // 내부 세로 스크롤 끔
    freeScroll: false,
    eventPassthrough: 'vertical',   // ▼ 세로는 페이지로 패스 (핵심)

    useTransition: false,
    useTransform: true,
    HWCompositing: true,

    momentum: true,
    bounce: false,                  // 흰띠/튕김 방지
    bounceTime: 300,
    deceleration: 0.0006,

    disableMouse: true,
    disablePointer: true,
    disableTouch: false,

    click: true,
    tap: true,

    preventDefault: false,          // 페이지 스크롤 살리기
    preventDefaultException: { tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/i }
  });

  // 3) 경계/점프 방지 패치(안정성 ↑)
  var ET = IScrollZoom.utils && IScrollZoom.utils.eventType;

  // zoom 종료 시 현재 위치를 하드 클램프(세로는 항상 0)
  IScrollZoom.prototype._zoomEnd = (function(orig){
    return function(e){
      if (!this.enabled || (ET && ET[e.type] !== this.initiated)) return;
      if (this.options.preventDefault && e && e.cancelable) e.preventDefault();
      this.isInTransition = 0;
      this.initiated = 0;

      if (this.scale > this.options.zoomMax) this.scale = this.options.zoomMax;
      if (this.scale < this.options.zoomMin) this.scale = this.options.zoomMin;

      this.refresh();

      var x = this.x;
      if (!this.hasHorizontalScroll || x > 0) x = 0;
      else if (x < this.maxScrollX) x = this.maxScrollX;

      var y = 0; // 내부 세로 스크롤은 사용 안 함

      if (x !== this.x || y !== this.y) this.scrollTo(x, y, this.options.bounceTime);
      else this._execEvent('scrollEnd');

      this.scaled = false;
      this._execEvent('zoomEnd');
    };
  })(IScrollZoom.prototype._zoomEnd);

  // refresh도 세로축 0으로 유지 & 하드 클램프
  IScrollZoom.prototype.refresh = (function(orig){
    return function(){
      orig.call(this);

      this.hasVerticalScroll = false;
      this.maxScrollY = 0;

      var nx = this.x;
      if (!this.hasHorizontalScroll || nx > 0) nx = 0;
      else if (nx < this.maxScrollX) nx = this.maxScrollX;

      if (nx !== this.x || this.y !== 0) this._translate(nx, 0);
      this._execEvent('refresh');
    };
  })(IScrollZoom.prototype.refresh);

  // 4) 이미지/뷰포트 변화 시 경계 갱신
  function onReady(){ fixOneXHeight(); z.refresh(); }
  window.addEventListener('resize', onReady);
  if (window.visualViewport){
    visualViewport.addEventListener('resize', onReady);
    visualViewport.addEventListener('scroll', onReady);
  }

  // 디버깅용 핸들
  root._iscrollZoom = z;
})();
</script>
</body>
</html>
